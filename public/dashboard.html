<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pockit ‚Äì Dashboard</title>
  <link rel="stylesheet" href="css/style.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Inter:wght@400;600&family=Montserrat:wght@700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="js/theme.js"></script>
  <script src="js/totalsContext.js"></script>
  <script src="js/dashboard.js"></script>
  <style>
    /* Dashboard-specific overrides (if needed) */
    .dashboard-container { display: flex; min-height: 100vh; background: #F9FBF4; }
    .sidebar { width: 240px; background: #fff; box-shadow: 2px 0 12px rgba(44,62,80,0.04); display: flex; flex-direction: column; align-items: stretch; padding: 0; }
    .sidebar-header { display: flex; align-items: center; gap: 12px; padding: 32px 24px 24px 24px; }
    .sidebar-logo { width: 38px; height: 38px; border-radius: 12px; background: linear-gradient(135deg, #00BFFF 60%, #1DE9B6 100%); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #fff; font-weight: 700; }
    .sidebar-title { font-size: 1.35rem; font-weight: 700; color: #00BFFF; font-family: 'Montserrat',sans-serif; }
    .sidebar-menu { display: flex; flex-direction: column; gap: 4px; margin-top: 32px; }
    .sidebar-link { display: flex; align-items: center; gap: 12px; padding: 12px 28px; font-size: 1.08rem; color: #2C3E50; text-decoration: none; border-radius: 8px 0 0 8px; font-weight: 500; transition: background 0.15s, color 0.15s; }
    .sidebar-link.active { background: #E6F7FF; color: #00BFFF; font-weight: 700; }
    .sidebar-link .icon { font-size: 1.2rem; }
    .sidebar-link:hover:not(.active) { background: #F2FAFF; color: #00BFFF; }
    .sidebar-spacer { flex: 1; }
    .sidebar-logout { margin: 24px 0 24px 0; text-align: center; }
    .logout-btn { background: #fff; color: #00BFFF; border: 1.5px solid #00BFFF; border-radius: 8px; padding: 8px 24px; font-weight: 600; cursor: pointer; transition: background 0.15s, color 0.15s; }
    .logout-btn:hover { background: #00BFFF; color: #fff; }
    /* Main content */
    .main-content { flex: 1; padding: 36px 36px 24px 36px; }
    .dashboard-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 24px; }
    .dashboard-greeting { }
    .dashboard-greeting h1 { font-size: 2rem; font-weight: 700; margin: 0 0 6px 0; color: #2C3E50; }
    .dashboard-greeting p { color: #7B8A97; font-size: 1.08rem; margin: 0; }
    .dashboard-header-right { display: flex; align-items: center; gap: 24px; }
    .currency-select { background: #fff; border: 1.5px solid #E0E0E0; border-radius: 8px; padding: 6px 18px; font-size: 1rem; color: #2C3E50; font-weight: 500; outline: none; }
    .last-updated { color: #7B8A97; font-size: 0.98rem; }
    
    /* Unified Top Bar Layout */
    .top-bar { display: flex; align-items: center; justify-content: flex-end; gap: 1rem; margin-right: 2rem; margin-top: 1rem; }
    .add-btn { background: #00BFFF; color: #fff; border: none; border-radius: 8px; font-weight: 700; font-size: 1.08rem; padding: 10px 28px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,191,255,0.08); transition: background 0.18s; }
    .add-btn:hover { background: #1DE9B6; color: #2C3E50; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: #0056A8; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: background 0.2s, transform 0.2s; }
    .user-avatar:hover { background: #004080; transform: scale(1.05); }
    
    /* User Profile Dropdown */
    .user-profile-dropdown { position: relative; }
    .dropdown-menu { position: absolute; top: 100%; right: 0; margin-top: 8px; background: #fff; border-radius: 12px; box-shadow: 0 8px 32px rgba(44,62,80,0.12); min-width: 280px; z-index: 1000; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s ease; border: 1px solid #F0F0F0; }
    .dropdown-menu.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .dropdown-header { padding: 20px; display: flex; align-items: center; gap: 12px; }
    .dropdown-avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #00BFFF 60%, #1DE9B6 100%); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem; }
    .dropdown-user-info { flex: 1; }
    .dropdown-name { font-size: 1.1rem; font-weight: 700; color: #2C3E50; margin-bottom: 4px; }
    .dropdown-email { font-size: 0.95rem; color: #7B8A97; }
    .dropdown-divider { height: 1px; background: #F0F0F0; margin: 0; }
    .dropdown-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #2C3E50; text-decoration: none; font-size: 1rem; font-weight: 500; transition: background 0.2s; border: none; background: none; width: 100%; text-align: left; cursor: pointer; }
    .dropdown-item:hover { background: #F8F9FA; color: #00BFFF; }
    .dropdown-item.logout-item:hover { background: #FFF5F5; color: #FF5A5A; }
    .dropdown-icon { font-size: 1.1rem; }
    /* Cards */
    .dashboard-cards { display: flex; gap: 24px; margin-bottom: 24px; }
    .dashboard-card { flex: 1; background: #fff; border-radius: 16px; box-shadow: 0 2px 12px rgba(44,62,80,0.07); padding: 24px 24px 18px 24px; display: flex; flex-direction: column; gap: 8px; min-width: 180px; }
    .dashboard-card .card-title { font-size: 1.08rem; color: #7B8A97; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .dashboard-card .card-value { font-size: 1.7rem; font-weight: 700; color: #2C3E50; margin: 2px 0 0 0; }
    .dashboard-card .card-change { font-size: 0.98rem; font-weight: 500; display: flex; align-items: center; gap: 4px; }
    .card-change.positive { color: #1DE9B6; }
    .card-change.negative { color: #FF5A5A; }
    .card-change.neutral { color: #00BFFF; }
    .dashboard-card .card-icon { font-size: 1.2rem; margin-left: 6px; }
    /* Charts */
    .dashboard-graphs { display: flex; gap: 24px; margin-bottom: 24px; }
    .dashboard-graph { background: #fff; border-radius: 16px; box-shadow: 0 2px 12px rgba(44,62,80,0.07); padding: 24px; flex: 1; min-width: 320px; display: flex; flex-direction: column; }
    .dashboard-graph-title { font-size: 1.15rem; font-weight: 700; color: #2C3E50; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
    .dashboard-graph-desc { color: #7B8A97; font-size: 0.98rem; margin-bottom: 16px; }
    .dashboard-graph-canvas { width: 100%; height: 220px; }
    .dashboard-graph-canvas.line { height: 180px; }
    .dashboard-graph-canvas.bar { height: 180px; }
    /* Responsive */
    @media (max-width: 1100px) {
      .dashboard-cards, .dashboard-graphs { flex-direction: column; gap: 18px; }
      .main-content { padding: 24px 8px; }
      .sidebar { width: 100px; }
      .sidebar-title { display: none; }
      .sidebar-link { padding: 12px 10px; font-size: 0.98rem; }
    }
    @media (max-width: 700px) {
      .dashboard-container { flex-direction: column; }
      .sidebar { width: 100%; flex-direction: row; height: 60px; box-shadow: 0 2px 12px rgba(44,62,80,0.07); }
      .sidebar-header, .sidebar-spacer, .sidebar-logout { display: none; }
      .sidebar-menu { flex-direction: row; gap: 0; margin: 0; width: 100%; justify-content: space-around; }
      .sidebar-link { border-radius: 0; padding: 10px 0; justify-content: center; width: 100%; }
      .main-content { padding: 12px 2vw; }
      .dropdown-menu { min-width: 260px; right: -10px; }
      .dashboard-header-right { gap: 12px; }
      .last-updated { font-size: 0.9rem; }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">P</div>
        <div class="sidebar-title">Pockit</div>
      </div>
      <hr style="border:none;border-top:1.5px solid #F0F0F0;margin:0 18px 0 18px;">
      <div style="font-size:0.98rem;color:#7B8A97;font-weight:600;padding:18px 0 6px 28px;letter-spacing:0.5px;">Menu</div>
      <nav class="sidebar-menu">
        <a href="#" class="sidebar-link active"><span class="icon">üè†</span>Dashboard</a>
        <a href="expense.html" class="sidebar-link"><span class="icon">üí∏</span>Expenses</a>
        <a href="emi.html" class="sidebar-link"><span class="icon">üìÖ</span>EMI Manager</a>
        <a href="debt.html" class="sidebar-link"><span class="icon">üìä</span>Debt Tracker</a>
        <a href="savings.html" class="sidebar-link"><span class="icon">üéØ</span>Savings Goals</a>
      </nav>
      <div class="sidebar-spacer"></div>
      <div class="sidebar-logout">
        <button class="logout-btn" onclick="handleLogout()">Logout</button>
      </div>
    </aside>
    <!-- Main Content -->
    <main class="main-content">
      <!-- Header -->
      <div class="dashboard-header">
        <div class="dashboard-greeting">
          <h1>Welcome back, John!</h1>
          <p>Here's your financial overview for this month</p>
        </div>
        <div class="dashboard-header-right">
          <div class="last-updated">Last updated<br><span id="currentDate">Today, 10/07/2025</span></div>
          <div class="top-bar">
            <div class="user-profile-dropdown">
              <div class="user-avatar" id="userAvatar" onclick="toggleDropdown()">JD</div>
              <div class="dropdown-menu" id="dropdownMenu">
                <div class="dropdown-header">
                  <div class="dropdown-avatar" id="dropdownAvatar">JD</div>
                  <div class="dropdown-user-info">
                    <div class="dropdown-name" id="dropdownName">John Doe</div>
                    <div class="dropdown-email" id="dropdownEmail">john@example.com</div>
                  </div>
                </div>
                <div class="dropdown-divider"></div>
                <a href="profile.html" class="dropdown-item">
                  <span class="dropdown-icon">üë§</span>
                  View Profile
                </a>
                <a href="settings.html" class="dropdown-item">
                  <span class="dropdown-icon">‚öôÔ∏è</span>
                  Settings
                </a>
                <div class="dropdown-divider"></div>
                <button class="dropdown-item logout-item" onclick="handleLogout()">
                  <span class="dropdown-icon">üö™</span>
                  Log out
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Cards -->
      <div class="dashboard-cards">
        <div class="dashboard-card">
          <div class="card-title">Total Balance <span class="card-icon">üí∞</span></div>
          <div class="card-value" id="totalBalance">‚Çπ0</div>
          <div class="card-change positive">+5.2% from last month</div>
        </div>
        <div class="dashboard-card">
          <div class="card-title">Monthly Income <span class="card-icon">üí≥</span></div>
          <div class="card-value" id="monthlyIncome">‚Çπ0</div>
          <div class="card-change positive">+2.1% from last month</div>
        </div>
        <div class="dashboard-card">
          <div class="card-title">Monthly Expenses <span class="card-icon">üí∏</span></div>
          <div class="card-value" id="monthlyExpenses">‚Çπ0</div>
          <div class="card-change negative">-8.3% from last month</div>
        </div>
        <div class="dashboard-card">
          <div class="card-title">Savings Goal <span class="card-icon">üéØ</span></div>
          <div class="card-value" id="savingsGoal">‚Çπ0</div>
          <div class="card-change neutral">+12% from last month</div>
        </div>
      </div>
      <!-- Graphs -->
      <div class="dashboard-graphs">
        <div class="dashboard-graph" style="flex:1.2; min-width:0; height:320px;">
          <div class="dashboard-graph-title"><span class="icon">üìä</span>Expense Breakdown</div>
          <div class="dashboard-graph-desc">Your spending categories this month</div>
          <div style="flex:1; min-height:0; height:220px; display:flex;"><canvas id="expensePie" class="dashboard-graph-canvas" style="width:100%!important; height:100%!important;"></canvas></div>
        </div>
        <div class="dashboard-graph" style="flex:1; min-width:0; height:320px;">
          <div class="dashboard-graph-title"><span class="icon">üìà</span>Savings Trend</div>
          <div class="dashboard-graph-desc">Your savings progress over time</div>
          <div style="flex:1; min-height:0; height:220px; display:flex;"><canvas id="savingsLine" class="dashboard-graph-canvas line" style="width:100%!important; height:100%!important;"></canvas></div>
        </div>
      </div>
      <div class="dashboard-graph" style="margin-bottom:0; height:320px;">
        <div class="dashboard-graph-title"><span class="icon">üìä</span>Income vs Expenses</div>
        <div class="dashboard-graph-desc">Monthly comparison of your income and spending</div>
        <div style="flex:1; min-height:0; height:220px; display:flex;"><canvas id="incomeBar" class="dashboard-graph-canvas bar" style="width:100%!important; height:100%!important;"></canvas></div>
      </div>
      

    </main>
  </div>
  <script>
    // Dropdown functionality
    function toggleDropdown() {
      const dropdown = document.getElementById('dropdownMenu');
      dropdown.classList.toggle('show');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('dropdownMenu');
      const avatar = document.getElementById('userAvatar');
      
      if (!dropdown.contains(event.target) && !avatar.contains(event.target)) {
        dropdown.classList.remove('show');
      }
    });

    // Close dropdown on escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        const dropdown = document.getElementById('dropdownMenu');
        dropdown.classList.remove('show');
      }
    });

    // Logout function
    async function handleLogout() {
      try {
        // Try to logout from server
        const response = await fetch('/api/logout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        // Clear localStorage regardless of server response
        localStorage.removeItem('user');
        
        // Redirect to login with logout parameter to clear any cached data
        window.location.href = 'login.html?logout=true';
      } catch (error) {
        console.error('Logout error:', error);
        // Clear localStorage and redirect to login
        localStorage.removeItem('user');
        window.location.href = 'login.html?logout=true';
      }
    }

    // Navigation: simulate login/register to dashboard
    document.querySelectorAll('.auth-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = 'dashboard.html';
      });
    });


    window.addEventListener('DOMContentLoaded', async () => {
      try {
        // Update the current date dynamically
        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = today.getFullYear();
        const currentDateElement = document.getElementById('currentDate');
        if (currentDateElement) {
          currentDateElement.textContent = `Today, ${day}/${month}/${year}`;
        }

        // Check if user is logged in
        const storedUser = localStorage.getItem('user');
        if (!storedUser) {
          // Redirect to login if not logged in
          window.location.href = 'login.html';
          return;
        }

        let user;
        
        // Try to fetch current user data from server first
        try {
          const res = await fetch('/api/current-user');
          if (res.ok) {
            user = await res.json();
          } else {
            // If server session expired, use localStorage data
            user = JSON.parse(storedUser);
          }
        } catch (error) {
          // If server is not reachable, use localStorage data
          user = JSON.parse(storedUser);
        }

        // Populate user data
        document.querySelector('.dashboard-greeting h1').textContent = `Welcome back, ${user.name}!`;
        document.querySelector('.dashboard-greeting p').textContent = `Here's your financial overview for this month`;
        
        // Generate initials from user name
        const initials = user.name.split(' ').map(n => n[0]).join('');
        
        // Update avatar and dropdown
        document.getElementById('userAvatar').textContent = initials;
        document.getElementById('dropdownAvatar').textContent = initials;
        document.getElementById('dropdownName').textContent = user.name;
        document.getElementById('dropdownEmail').textContent = user.email;

        // Fetch financial data from MongoDB
        let financialData;
        try {
          const financialRes = await fetch('/api/financial-data');
          if (financialRes.ok) {
            financialData = await financialRes.json();
          } else {
            console.error('Failed to fetch financial data');
            financialData = {
              totalExpense: 0,
              totalEMI: 0,
              totalDebt: 0,
              totalSavings: 0,
              monthlyIncome: user.salary || 0,
              expenseBreakdown: { rent: 0, food: 0, transport: 0, utilities: 0, others: 0 },
              savingsHistory: [],
              incomeExpenseHistory: []
            };
          }
        } catch (error) {
          console.error('Error fetching financial data:', error);
          financialData = {
            totalExpense: 0,
            totalEMI: 0,
            totalDebt: 0,
            totalSavings: 0,
            monthlyIncome: user.salary || 0,
            expenseBreakdown: { rent: 0, food: 0, transport: 0, utilities: 0, others: 0 },
            savingsHistory: [],
            incomeExpenseHistory: []
          };
        }

        // Calculate total balance (income - expenses)
        const totalBalance = financialData.monthlyIncome - financialData.totalExpense;
        
        // Update dashboard cards with real data
        document.getElementById('totalBalance').textContent = `‚Çπ${totalBalance.toLocaleString()}`;
        document.getElementById('monthlyIncome').textContent = `‚Çπ${financialData.monthlyIncome.toLocaleString()}`;
        document.getElementById('monthlyExpenses').textContent = `‚Çπ${financialData.totalExpense.toLocaleString()}`;
        document.getElementById('savingsGoal').textContent = `‚Çπ${financialData.totalSavings.toLocaleString()}`;

        // Update charts with real data
        updateCharts(financialData);

      } catch (err) {
        console.error('‚ùå Failed to fetch user data:', err);
        // Clear localStorage and redirect to login on error
        localStorage.removeItem('user');
        window.location.href = 'login.html';
      }
    });

    // Function to update charts with real data
    function updateCharts(financialData) {
      // Update Pie Chart (Expense Breakdown)
      const expenseBreakdown = financialData.expenseBreakdown;
      const totalExpense = financialData.totalExpense;
      
      let pieLabels = [];
      let pieData = [];
      let pieColors = ['#FF5A5A', '#00BFFF', '#1DE9B6', '#FFE066', '#B39DDB'];
      
      if (totalExpense > 0) {
        const categories = [
          { key: 'rent', label: 'Rent' },
          { key: 'food', label: 'Food' },
          { key: 'transport', label: 'Transport' },
          { key: 'utilities', label: 'Utilities' },
          { key: 'others', label: 'Others' }
        ];
        
        categories.forEach((category, index) => {
          const amount = expenseBreakdown[category.key] || 0;
          const percentage = totalExpense > 0 ? Math.round((amount / totalExpense) * 100) : 0;
          if (amount > 0) {
            pieLabels.push(`${category.label} ${percentage}%`);
            pieData.push(amount);
          }
        });
      }
      
      // If no data, show placeholder
      if (pieData.length === 0) {
        pieLabels = ['No expenses yet'];
        pieData = [1];
        pieColors = ['#E0E0E0'];
      }

      // Destroy existing chart if it exists
      if (window.expensePieChart) {
        window.expensePieChart.destroy();
      }

      window.expensePieChart = new Chart(document.getElementById('expensePie'), {
        type: 'pie',
        data: {
          labels: pieLabels,
          datasets: [{
            data: pieData,
            backgroundColor: pieColors,
            borderWidth: 0
          }]
        },
        options: {
          plugins: { legend: { position: 'right', labels: { font: { size: 14 } } } },
          responsive: true,
          maintainAspectRatio: false
        }
      });

      // Update Line Chart (Savings Trend)
      const savingsHistory = financialData.savingsHistory || [];
      const lineLabels = savingsHistory.map(item => item.month) || ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
      const lineData = savingsHistory.map(item => item.amount) || [0, 0, 0, 0, 0, 0];

      // Destroy existing chart if it exists
      if (window.savingsLineChart) {
        window.savingsLineChart.destroy();
      }

      window.savingsLineChart = new Chart(document.getElementById('savingsLine'), {
        type: 'line',
        data: {
          labels: lineLabels,
          datasets: [{
            label: 'Savings',
            data: lineData,
            borderColor: '#00BFFF',
            backgroundColor: 'rgba(0,191,255,0.08)',
            tension: 0.4,
            pointBackgroundColor: '#00BFFF',
            pointRadius: 5,
            fill: false
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, grid: { color: '#F0F0F0' } },
            x: { grid: { color: '#F0F0F0' } }
          }
        }
      });

      // Update Bar Chart (Income vs Expenses)
      const incomeExpenseHistory = financialData.incomeExpenseHistory || [];
      const barLabels = incomeExpenseHistory.map(item => item.month) || ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
      const incomeData = incomeExpenseHistory.map(item => item.income) || [0, 0, 0, 0, 0, 0];
      const expenseData = incomeExpenseHistory.map(item => item.expense) || [0, 0, 0, 0, 0, 0];

      // Destroy existing chart if it exists
      if (window.incomeBarChart) {
        window.incomeBarChart.destroy();
      }

      window.incomeBarChart = new Chart(document.getElementById('incomeBar'), {
        type: 'bar',
        data: {
          labels: barLabels,
          datasets: [
            {
              label: 'Income',
              data: incomeData,
              backgroundColor: '#00BFFF',
              borderRadius: 8,
              barPercentage: 0.45
            },
            {
              label: 'Expense',
              data: expenseData,
              backgroundColor: '#1DE9B6',
              borderRadius: 8,
              barPercentage: 0.45
            }
          ]
        },
        options: {
          plugins: { legend: { display: true, position: 'top' } },
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, grid: { color: '#F0F0F0' } },
            x: { grid: { color: '#F0F0F0' } }
          }
        }
      });
    }

  </script>
</body>
</html> 